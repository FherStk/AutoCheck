/*
    Copyright Â© 2022 Fernando Porrino Serrano
    Third party software licenses can be found at /docs/credits/credits.md

    This file is part of AutoCheck.

    AutoCheck is free software: you can redistribute it and/or modify
    it under the terms of the GNU Affero General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    AutoCheck is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU Affero General Public License for more details.

    You should have received a copy of the GNU Affero General Public License
    along with AutoCheck.  If not, see <https://www.gnu.org/licenses/>.
*/

using System.IO;
using NUnit.Framework;

namespace AutoCheck.Test
{    
    [Parallelizable(ParallelScope.All)]    
    public class RealPermissions : Test
    { 
        public RealPermissions(): base("script/real"){
        }        

        [NonParallelizable] //cannot interfear with the batch one, shares users and roles
        [Test, Category("FullScriptPermissions"), Category("Real"), Category("Local")]
        public void Real_PERMISSIONS_SCRIPT_SINGLE_1()
        {
            //TODO: the SQL script should create also users and restore the privileges.

            //Note: cannot be splitted or parallelized, must be done sequentualy because users and roles are shared alog the postgres instance.
            var conn = new AutoCheck.Core.Connectors.Postgres("localhost", "empresa", "postgres", "postgres");
            if(!conn.ExistsDataBase()) conn.CreateDataBase();

            //Restoring users and roles
            if(!conn.ExistsUser("it")) conn.CreateUser("it", "it");
            else conn.DropUserMembership("it");

            if(!conn.ExistsRole("rrhhadmin")) conn.CreateRole("rrhhadmin");
            else conn.DropRoleMembership("rrhhadmin");

            if(!conn.ExistsRole("prodadmin")) conn.CreateRole("prodadmin");
            else conn.DropRoleMembership("prodadmin");

            if(!conn.ExistsRole("dbadmin")) conn.CreateRole("dbadmin");
            else conn.DropRoleMembership("dbadmin");               
            
            //Restoring database
            var privatePath = Path.Combine(SamplesRootFolder, "private", "permissions");
            conn.CreateDataBase(Path.Combine(privatePath, "restore.sql"), true);

            //Original status
            var sample = GetSampleFile("real_permissions_single_1.yaml");
            var s = new AutoCheck.Core.Script(sample);                        
            Assert.AreEqual("Running script ASIX - M02 (UF3): Permissions Assignment (v1.2.0.0):\r\nRunning on single mode:\r\n   Question 1 [0 points] - This questions does not score:\r\n\r\n   Question 2 [1 point] - Foreign key (I):\r\n      Checking foreign key 'empleats -> empleats'...ERROR:\n         -Expected -> True; Found -> False\r\n\r\n   Question 3 [1 point] - Foreign key (II):\r\n      Checking foreign key 'empleats -> departaments'...ERROR:\n         -Expected -> True; Found -> False\r\n\r\n   Question 4 [1 point] - Privileges over 'empleats':\r\n      Checking new entries...ERROR:\n         -Expected -> >0; Found -> 0\r\n      Checking table privileges...ERROR:\n         -Expected -> %a%; Found -> rwdDxt\r\n\r\n   Question 5 [0 points] - This questions does not score:\r\n\r\n   Question 6 [1 point] - Privileges over 'fabricacio':\r\n      Checking foreign key 'fabricacio -> fabriques'...ERROR:\n         -Expected -> True; Found -> False\r\n      Checking foreign key 'fabricacio -> productes'...ERROR:\n         -Expected -> True; Found -> False\r\n      Checking table privileges...ERROR:\n         -Expected -> %x%; Found -> arwdDt\r\n\r\n   Question 7 [2 points] - Privileges over 'fabriques':\r\n      Checking foreign key 'fabriques -> empleats'...ERROR:\n         -Expected -> True; Found -> False\r\n      Checking schema privileges...ERROR:\n         -Expected -> %U%; Found -> \r\n      Checking table privileges...ERROR:\n         -Expected -> %x%; Found -> \r\n\r\n   Question 8 [1 point] - Privileges for rrhhadmin and prodadmin:\r\n      Checking removed entries...ERROR:\n         -Expected -> 0; Found -> 1\r\n      Checking 'rrhhadmin' privileges for the table 'empleats'...ERROR:\n         -Expected -> arwxt; Found -> rwdDxt\r\n      Checking 'rrhhadmin' privileges for the table 'departaments'...ERROR:\n         -Expected -> arwxt; Found -> arwdDxt\r\n      Checking 'prodadmin' privileges for the table 'fabriques'...ERROR:\n         -Expected -> arwxt; Found -> arwdDxt\r\n      Checking 'prodadmin' privileges for the table 'productes'...ERROR:\n         -Expected -> arwxt; Found -> arwdDt\r\n      Checking 'prodadmin' privileges for the table 'fabricacio'...ERROR:\n         -Expected -> arwxt; Found -> arwdDxt\r\n\r\n   Question 9 [3 points] - Privileges for dbadmin:\r\n\r\n      Question 9.1 [1 point] - Role membership:\r\n         Checking dbadmin membership...ERROR:\n            -Expected -> [prodadmin,rrhhadmin]; Found -> []\r\n\r\n      Question 9.2 [2 points] - Role privileges:\r\n         Checking 'dbadmin' privileges for the table 'empleats'...ERROR:\n            -Expected -> dD; Found -> \r\n         Checking 'dbadmin' privileges for the table 'departaments'...ERROR:\n            -Expected -> dD; Found -> \r\n         Checking 'dbadmin' privileges for the table 'fabriques'...ERROR:\n            -Expected -> dD; Found -> \r\n         Checking 'dbadmin' privileges for the table 'productes'...ERROR:\n            -Expected -> dD; Found -> \r\n         Checking 'dbadmin' privileges for the table 'fabricacio'...ERROR:\n            -Expected -> dD; Found -> \r\n\r\n   TOTAL SCORE: 0 / 10", s.Output.ToString());

            //Solve question 2 (question 1 does not score)
            conn.ImportSqlDump(Path.Combine(privatePath, "solve_ex2.sql"));
            s = new AutoCheck.Core.Script(sample);                        
            Assert.AreEqual("Running script ASIX - M02 (UF3): Permissions Assignment (v1.2.0.0):\r\nRunning on single mode:\r\n   Question 1 [0 points] - This questions does not score:\r\n\r\n   Question 2 [1 point] - Foreign key (I):\r\n      Checking foreign key 'empleats -> empleats'...OK\r\n\r\n   Question 3 [1 point] - Foreign key (II):\r\n      Checking foreign key 'empleats -> departaments'...ERROR:\n         -Expected -> True; Found -> False\r\n\r\n   Question 4 [1 point] - Privileges over 'empleats':\r\n      Checking new entries...ERROR:\n         -Expected -> >0; Found -> 0\r\n      Checking table privileges...ERROR:\n         -Expected -> %a%; Found -> rwdDxt\r\n\r\n   Question 5 [0 points] - This questions does not score:\r\n\r\n   Question 6 [1 point] - Privileges over 'fabricacio':\r\n      Checking foreign key 'fabricacio -> fabriques'...ERROR:\n         -Expected -> True; Found -> False\r\n      Checking foreign key 'fabricacio -> productes'...ERROR:\n         -Expected -> True; Found -> False\r\n      Checking table privileges...ERROR:\n         -Expected -> %x%; Found -> arwdDt\r\n\r\n   Question 7 [2 points] - Privileges over 'fabriques':\r\n      Checking foreign key 'fabriques -> empleats'...ERROR:\n         -Expected -> True; Found -> False\r\n      Checking schema privileges...ERROR:\n         -Expected -> %U%; Found -> \r\n      Checking table privileges...ERROR:\n         -Expected -> %x%; Found -> \r\n\r\n   Question 8 [1 point] - Privileges for rrhhadmin and prodadmin:\r\n      Checking removed entries...ERROR:\n         -Expected -> 0; Found -> 1\r\n      Checking 'rrhhadmin' privileges for the table 'empleats'...ERROR:\n         -Expected -> arwxt; Found -> rwdDxt\r\n      Checking 'rrhhadmin' privileges for the table 'departaments'...ERROR:\n         -Expected -> arwxt; Found -> arwdDxt\r\n      Checking 'prodadmin' privileges for the table 'fabriques'...ERROR:\n         -Expected -> arwxt; Found -> arwdDxt\r\n      Checking 'prodadmin' privileges for the table 'productes'...ERROR:\n         -Expected -> arwxt; Found -> arwdDt\r\n      Checking 'prodadmin' privileges for the table 'fabricacio'...ERROR:\n         -Expected -> arwxt; Found -> arwdDxt\r\n\r\n   Question 9 [3 points] - Privileges for dbadmin:\r\n\r\n      Question 9.1 [1 point] - Role membership:\r\n         Checking dbadmin membership...ERROR:\n            -Expected -> [prodadmin,rrhhadmin]; Found -> []\r\n\r\n      Question 9.2 [2 points] - Role privileges:\r\n         Checking 'dbadmin' privileges for the table 'empleats'...ERROR:\n            -Expected -> dD; Found -> \r\n         Checking 'dbadmin' privileges for the table 'departaments'...ERROR:\n            -Expected -> dD; Found -> \r\n         Checking 'dbadmin' privileges for the table 'fabriques'...ERROR:\n            -Expected -> dD; Found -> \r\n         Checking 'dbadmin' privileges for the table 'productes'...ERROR:\n            -Expected -> dD; Found -> \r\n         Checking 'dbadmin' privileges for the table 'fabricacio'...ERROR:\n            -Expected -> dD; Found -> \r\n\r\n   TOTAL SCORE: 1 / 10", s.Output.ToString());

            //Solve question 3
            conn.ImportSqlDump(Path.Combine(privatePath, "solve_ex3.sql"));
            s = new AutoCheck.Core.Script(sample);                        
            Assert.AreEqual("Running script ASIX - M02 (UF3): Permissions Assignment (v1.2.0.0):\r\nRunning on single mode:\r\n   Question 1 [0 points] - This questions does not score:\r\n\r\n   Question 2 [1 point] - Foreign key (I):\r\n      Checking foreign key 'empleats -> empleats'...OK\r\n\r\n   Question 3 [1 point] - Foreign key (II):\r\n      Checking foreign key 'empleats -> departaments'...OK\r\n\r\n   Question 4 [1 point] - Privileges over 'empleats':\r\n      Checking new entries...ERROR:\n         -Expected -> >0; Found -> 0\r\n      Checking table privileges...ERROR:\n         -Expected -> %a%; Found -> rwdDxt\r\n\r\n   Question 5 [0 points] - This questions does not score:\r\n\r\n   Question 6 [1 point] - Privileges over 'fabricacio':\r\n      Checking foreign key 'fabricacio -> fabriques'...ERROR:\n         -Expected -> True; Found -> False\r\n      Checking foreign key 'fabricacio -> productes'...ERROR:\n         -Expected -> True; Found -> False\r\n      Checking table privileges...ERROR:\n         -Expected -> %x%; Found -> arwdDt\r\n\r\n   Question 7 [2 points] - Privileges over 'fabriques':\r\n      Checking foreign key 'fabriques -> empleats'...ERROR:\n         -Expected -> True; Found -> False\r\n      Checking schema privileges...ERROR:\n         -Expected -> %U%; Found -> \r\n      Checking table privileges...ERROR:\n         -Expected -> %x%; Found -> \r\n\r\n   Question 8 [1 point] - Privileges for rrhhadmin and prodadmin:\r\n      Checking removed entries...ERROR:\n         -Expected -> 0; Found -> 1\r\n      Checking 'rrhhadmin' privileges for the table 'empleats'...ERROR:\n         -Expected -> arwxt; Found -> rwdDxt\r\n      Checking 'rrhhadmin' privileges for the table 'departaments'...ERROR:\n         -Expected -> arwxt; Found -> arwdDxt\r\n      Checking 'prodadmin' privileges for the table 'fabriques'...ERROR:\n         -Expected -> arwxt; Found -> arwdDxt\r\n      Checking 'prodadmin' privileges for the table 'productes'...ERROR:\n         -Expected -> arwxt; Found -> arwdDt\r\n      Checking 'prodadmin' privileges for the table 'fabricacio'...ERROR:\n         -Expected -> arwxt; Found -> arwdDxt\r\n\r\n   Question 9 [3 points] - Privileges for dbadmin:\r\n\r\n      Question 9.1 [1 point] - Role membership:\r\n         Checking dbadmin membership...ERROR:\n            -Expected -> [prodadmin,rrhhadmin]; Found -> []\r\n\r\n      Question 9.2 [2 points] - Role privileges:\r\n         Checking 'dbadmin' privileges for the table 'empleats'...ERROR:\n            -Expected -> dD; Found -> \r\n         Checking 'dbadmin' privileges for the table 'departaments'...ERROR:\n            -Expected -> dD; Found -> \r\n         Checking 'dbadmin' privileges for the table 'fabriques'...ERROR:\n            -Expected -> dD; Found -> \r\n         Checking 'dbadmin' privileges for the table 'productes'...ERROR:\n            -Expected -> dD; Found -> \r\n         Checking 'dbadmin' privileges for the table 'fabricacio'...ERROR:\n            -Expected -> dD; Found -> \r\n\r\n   TOTAL SCORE: 2 / 10", s.Output.ToString());

            //Solve question 4
            conn.ImportSqlDump(Path.Combine(privatePath, "solve_ex4.sql"));
            s = new AutoCheck.Core.Script(sample);                        
            Assert.AreEqual("Running script ASIX - M02 (UF3): Permissions Assignment (v1.2.0.0):\r\nRunning on single mode:\r\n   Question 1 [0 points] - This questions does not score:\r\n\r\n   Question 2 [1 point] - Foreign key (I):\r\n      Checking foreign key 'empleats -> empleats'...OK\r\n\r\n   Question 3 [1 point] - Foreign key (II):\r\n      Checking foreign key 'empleats -> departaments'...OK\r\n\r\n   Question 4 [1 point] - Privileges over 'empleats':\r\n      Checking new entries...OK\r\n      Checking table privileges...OK\r\n\r\n   Question 5 [0 points] - This questions does not score:\r\n\r\n   Question 6 [1 point] - Privileges over 'fabricacio':\r\n      Checking foreign key 'fabricacio -> fabriques'...ERROR:\n         -Expected -> True; Found -> False\r\n      Checking foreign key 'fabricacio -> productes'...ERROR:\n         -Expected -> True; Found -> False\r\n      Checking table privileges...ERROR:\n         -Expected -> %x%; Found -> arwdDt\r\n\r\n   Question 7 [2 points] - Privileges over 'fabriques':\r\n      Checking foreign key 'fabriques -> empleats'...ERROR:\n         -Expected -> True; Found -> False\r\n      Checking schema privileges...ERROR:\n         -Expected -> %U%; Found -> \r\n      Checking table privileges...ERROR:\n         -Expected -> %x%; Found -> \r\n\r\n   Question 8 [1 point] - Privileges for rrhhadmin and prodadmin:\r\n      Checking removed entries...ERROR:\n         -Expected -> 0; Found -> 1\r\n      Checking 'rrhhadmin' privileges for the table 'empleats'...ERROR:\n         -Expected -> arwxt; Found -> arwdDxt\r\n      Checking 'rrhhadmin' privileges for the table 'departaments'...ERROR:\n         -Expected -> arwxt; Found -> arwdDxt\r\n      Checking 'prodadmin' privileges for the table 'fabriques'...ERROR:\n         -Expected -> arwxt; Found -> arwdDxt\r\n      Checking 'prodadmin' privileges for the table 'productes'...ERROR:\n         -Expected -> arwxt; Found -> arwdDt\r\n      Checking 'prodadmin' privileges for the table 'fabricacio'...ERROR:\n         -Expected -> arwxt; Found -> arwdDxt\r\n\r\n   Question 9 [3 points] - Privileges for dbadmin:\r\n\r\n      Question 9.1 [1 point] - Role membership:\r\n         Checking dbadmin membership...ERROR:\n            -Expected -> [prodadmin,rrhhadmin]; Found -> []\r\n\r\n      Question 9.2 [2 points] - Role privileges:\r\n         Checking 'dbadmin' privileges for the table 'empleats'...ERROR:\n            -Expected -> dD; Found -> \r\n         Checking 'dbadmin' privileges for the table 'departaments'...ERROR:\n            -Expected -> dD; Found -> \r\n         Checking 'dbadmin' privileges for the table 'fabriques'...ERROR:\n            -Expected -> dD; Found -> \r\n         Checking 'dbadmin' privileges for the table 'productes'...ERROR:\n            -Expected -> dD; Found -> \r\n         Checking 'dbadmin' privileges for the table 'fabricacio'...ERROR:\n            -Expected -> dD; Found -> \r\n\r\n   TOTAL SCORE: 3 / 10", s.Output.ToString());

            //Solve question 6 (question 5 does not score)
            conn.ImportSqlDump(Path.Combine(privatePath, "solve_ex6.sql"));
            s = new AutoCheck.Core.Script(sample);                        
            Assert.AreEqual("Running script ASIX - M02 (UF3): Permissions Assignment (v1.2.0.0):\r\nRunning on single mode:\r\n   Question 1 [0 points] - This questions does not score:\r\n\r\n   Question 2 [1 point] - Foreign key (I):\r\n      Checking foreign key 'empleats -> empleats'...OK\r\n\r\n   Question 3 [1 point] - Foreign key (II):\r\n      Checking foreign key 'empleats -> departaments'...OK\r\n\r\n   Question 4 [1 point] - Privileges over 'empleats':\r\n      Checking new entries...OK\r\n      Checking table privileges...OK\r\n\r\n   Question 5 [0 points] - This questions does not score:\r\n\r\n   Question 6 [1 point] - Privileges over 'fabricacio':\r\n      Checking foreign key 'fabricacio -> fabriques'...OK\r\n      Checking foreign key 'fabricacio -> productes'...OK\r\n      Checking table privileges...OK\r\n\r\n   Question 7 [2 points] - Privileges over 'fabriques':\r\n      Checking foreign key 'fabriques -> empleats'...ERROR:\n         -Expected -> True; Found -> False\r\n      Checking schema privileges...ERROR:\n         -Expected -> %U%; Found -> \r\n      Checking table privileges...ERROR:\n         -Expected -> %x%; Found -> \r\n\r\n   Question 8 [1 point] - Privileges for rrhhadmin and prodadmin:\r\n      Checking removed entries...ERROR:\n         -Expected -> 0; Found -> 1\r\n      Checking 'rrhhadmin' privileges for the table 'empleats'...ERROR:\n         -Expected -> arwxt; Found -> arwdDxt\r\n      Checking 'rrhhadmin' privileges for the table 'departaments'...ERROR:\n         -Expected -> arwxt; Found -> arwdDxt\r\n      Checking 'prodadmin' privileges for the table 'fabriques'...ERROR:\n         -Expected -> arwxt; Found -> arwdDxt\r\n      Checking 'prodadmin' privileges for the table 'productes'...ERROR:\n         -Expected -> arwxt; Found -> arwdDxt\r\n      Checking 'prodadmin' privileges for the table 'fabricacio'...ERROR:\n         -Expected -> arwxt; Found -> arwdDxt\r\n\r\n   Question 9 [3 points] - Privileges for dbadmin:\r\n\r\n      Question 9.1 [1 point] - Role membership:\r\n         Checking dbadmin membership...ERROR:\n            -Expected -> [prodadmin,rrhhadmin]; Found -> []\r\n\r\n      Question 9.2 [2 points] - Role privileges:\r\n         Checking 'dbadmin' privileges for the table 'empleats'...ERROR:\n            -Expected -> dD; Found -> \r\n         Checking 'dbadmin' privileges for the table 'departaments'...ERROR:\n            -Expected -> dD; Found -> \r\n         Checking 'dbadmin' privileges for the table 'fabriques'...ERROR:\n            -Expected -> dD; Found -> \r\n         Checking 'dbadmin' privileges for the table 'productes'...ERROR:\n            -Expected -> dD; Found -> \r\n         Checking 'dbadmin' privileges for the table 'fabricacio'...ERROR:\n            -Expected -> dD; Found -> \r\n\r\n   TOTAL SCORE: 4 / 10", s.Output.ToString());

            //Solve question 7
            conn.ImportSqlDump(Path.Combine(privatePath, "solve_ex7.sql"));
            s = new AutoCheck.Core.Script(sample);                        
            Assert.AreEqual("Running script ASIX - M02 (UF3): Permissions Assignment (v1.2.0.0):\r\nRunning on single mode:\r\n   Question 1 [0 points] - This questions does not score:\r\n\r\n   Question 2 [1 point] - Foreign key (I):\r\n      Checking foreign key 'empleats -> empleats'...OK\r\n\r\n   Question 3 [1 point] - Foreign key (II):\r\n      Checking foreign key 'empleats -> departaments'...OK\r\n\r\n   Question 4 [1 point] - Privileges over 'empleats':\r\n      Checking new entries...OK\r\n      Checking table privileges...OK\r\n\r\n   Question 5 [0 points] - This questions does not score:\r\n\r\n   Question 6 [1 point] - Privileges over 'fabricacio':\r\n      Checking foreign key 'fabricacio -> fabriques'...OK\r\n      Checking foreign key 'fabricacio -> productes'...OK\r\n      Checking table privileges...OK\r\n\r\n   Question 7 [2 points] - Privileges over 'fabriques':\r\n      Checking foreign key 'fabriques -> empleats'...OK\r\n      Checking schema privileges...OK\r\n      Checking table privileges...OK\r\n\r\n   Question 8 [1 point] - Privileges for rrhhadmin and prodadmin:\r\n      Checking removed entries...ERROR:\n         -Expected -> 0; Found -> 1\r\n      Checking 'rrhhadmin' privileges for the table 'empleats'...ERROR:\n         -Expected -> arwxt; Found -> arwdDxt\r\n      Checking 'rrhhadmin' privileges for the table 'departaments'...ERROR:\n         -Expected -> arwxt; Found -> arwdDxt\r\n      Checking 'prodadmin' privileges for the table 'fabriques'...ERROR:\n         -Expected -> arwxt; Found -> arwdDxt\r\n      Checking 'prodadmin' privileges for the table 'productes'...ERROR:\n         -Expected -> arwxt; Found -> arwdDxt\r\n      Checking 'prodadmin' privileges for the table 'fabricacio'...ERROR:\n         -Expected -> arwxt; Found -> arwdDxt\r\n\r\n   Question 9 [3 points] - Privileges for dbadmin:\r\n\r\n      Question 9.1 [1 point] - Role membership:\r\n         Checking dbadmin membership...ERROR:\n            -Expected -> [prodadmin,rrhhadmin]; Found -> []\r\n\r\n      Question 9.2 [2 points] - Role privileges:\r\n         Checking 'dbadmin' privileges for the table 'empleats'...ERROR:\n            -Expected -> dD; Found -> \r\n         Checking 'dbadmin' privileges for the table 'departaments'...ERROR:\n            -Expected -> dD; Found -> \r\n         Checking 'dbadmin' privileges for the table 'fabriques'...ERROR:\n            -Expected -> dD; Found -> \r\n         Checking 'dbadmin' privileges for the table 'productes'...ERROR:\n            -Expected -> dD; Found -> \r\n         Checking 'dbadmin' privileges for the table 'fabricacio'...ERROR:\n            -Expected -> dD; Found -> \r\n\r\n   TOTAL SCORE: 6 / 10", s.Output.ToString());
            
            //Solve question 8
            conn.ImportSqlDump(Path.Combine(privatePath, "solve_ex8.sql"));
            s = new AutoCheck.Core.Script(sample);                        
            Assert.AreEqual("Running script ASIX - M02 (UF3): Permissions Assignment (v1.2.0.0):\r\nRunning on single mode:\r\n   Question 1 [0 points] - This questions does not score:\r\n\r\n   Question 2 [1 point] - Foreign key (I):\r\n      Checking foreign key 'empleats -> empleats'...OK\r\n\r\n   Question 3 [1 point] - Foreign key (II):\r\n      Checking foreign key 'empleats -> departaments'...OK\r\n\r\n   Question 4 [1 point] - Privileges over 'empleats':\r\n      Checking new entries...OK\r\n      Checking table privileges...OK\r\n\r\n   Question 5 [0 points] - This questions does not score:\r\n\r\n   Question 6 [1 point] - Privileges over 'fabricacio':\r\n      Checking foreign key 'fabricacio -> fabriques'...OK\r\n      Checking foreign key 'fabricacio -> productes'...OK\r\n      Checking table privileges...OK\r\n\r\n   Question 7 [2 points] - Privileges over 'fabriques':\r\n      Checking foreign key 'fabriques -> empleats'...OK\r\n      Checking schema privileges...OK\r\n      Checking table privileges...OK\r\n\r\n   Question 8 [1 point] - Privileges for rrhhadmin and prodadmin:\r\n      Checking removed entries...OK\r\n      Checking 'rrhhadmin' privileges for the table 'empleats'...OK\r\n      Checking 'rrhhadmin' privileges for the table 'departaments'...OK\r\n      Checking 'prodadmin' privileges for the table 'fabriques'...OK\r\n      Checking 'prodadmin' privileges for the table 'productes'...OK\r\n      Checking 'prodadmin' privileges for the table 'fabricacio'...OK\r\n\r\n   Question 9 [3 points] - Privileges for dbadmin:\r\n\r\n      Question 9.1 [1 point] - Role membership:\r\n         Checking dbadmin membership...ERROR:\n            -Expected -> [prodadmin,rrhhadmin]; Found -> []\r\n\r\n      Question 9.2 [2 points] - Role privileges:\r\n         Checking 'dbadmin' privileges for the table 'empleats'...ERROR:\n            -Expected -> dD; Found -> \r\n         Checking 'dbadmin' privileges for the table 'departaments'...ERROR:\n            -Expected -> dD; Found -> \r\n         Checking 'dbadmin' privileges for the table 'fabriques'...ERROR:\n            -Expected -> dD; Found -> \r\n         Checking 'dbadmin' privileges for the table 'productes'...ERROR:\n            -Expected -> dD; Found -> \r\n         Checking 'dbadmin' privileges for the table 'fabricacio'...ERROR:\n            -Expected -> dD; Found -> \r\n\r\n   TOTAL SCORE: 7 / 10", s.Output.ToString());
            
            //Solve question 9
            conn.ImportSqlDump(Path.Combine(privatePath, "solve_ex9.sql"));
            s = new AutoCheck.Core.Script(sample);                        
            Assert.AreEqual("Running script ASIX - M02 (UF3): Permissions Assignment (v1.2.0.0):\r\nRunning on single mode:\r\n   Question 1 [0 points] - This questions does not score:\r\n\r\n   Question 2 [1 point] - Foreign key (I):\r\n      Checking foreign key 'empleats -> empleats'...OK\r\n\r\n   Question 3 [1 point] - Foreign key (II):\r\n      Checking foreign key 'empleats -> departaments'...OK\r\n\r\n   Question 4 [1 point] - Privileges over 'empleats':\r\n      Checking new entries...OK\r\n      Checking table privileges...OK\r\n\r\n   Question 5 [0 points] - This questions does not score:\r\n\r\n   Question 6 [1 point] - Privileges over 'fabricacio':\r\n      Checking foreign key 'fabricacio -> fabriques'...OK\r\n      Checking foreign key 'fabricacio -> productes'...OK\r\n      Checking table privileges...OK\r\n\r\n   Question 7 [2 points] - Privileges over 'fabriques':\r\n      Checking foreign key 'fabriques -> empleats'...OK\r\n      Checking schema privileges...OK\r\n      Checking table privileges...OK\r\n\r\n   Question 8 [1 point] - Privileges for rrhhadmin and prodadmin:\r\n      Checking removed entries...OK\r\n      Checking 'rrhhadmin' privileges for the table 'empleats'...OK\r\n      Checking 'rrhhadmin' privileges for the table 'departaments'...OK\r\n      Checking 'prodadmin' privileges for the table 'fabriques'...OK\r\n      Checking 'prodadmin' privileges for the table 'productes'...OK\r\n      Checking 'prodadmin' privileges for the table 'fabricacio'...OK\r\n\r\n   Question 9 [3 points] - Privileges for dbadmin:\r\n\r\n      Question 9.1 [1 point] - Role membership:\r\n         Checking dbadmin membership...OK\r\n\r\n      Question 9.2 [2 points] - Role privileges:\r\n         Checking 'dbadmin' privileges for the table 'empleats'...OK\r\n         Checking 'dbadmin' privileges for the table 'departaments'...OK\r\n         Checking 'dbadmin' privileges for the table 'fabriques'...OK\r\n         Checking 'dbadmin' privileges for the table 'productes'...OK\r\n         Checking 'dbadmin' privileges for the table 'fabricacio'...OK\r\n\r\n   TOTAL SCORE: 10 / 10", s.Output.ToString());            
        }

        [NonParallelizable] //cannot interfear with the single one, shares users and roles
        [Test, Category("FullScriptPermissions"), Category("Real"), Category("Local")]
        public void Real_PERMISSIONS_SCRIPT_BATCH_1()
        {             
            var s = new AutoCheck.Core.Script(GetSampleFile("real_permissions_batch_1.yaml"));     
            var expected = "Running script ASIX - M02 (UF3): Permissions Assignment (v1.2.0.0):\r\n   Extracting files at User Name 1_3196:\r\n      Extracting the file var.zip... OK\r\n\r\n   Extracting files at User Name 2_2987:\r\n      Extracting the file var.zip... OK\r\n\r\n   Extracting files at User Name 3_0981:\r\n      Extracting the file var.zip... OK\r\n\r\n   Starting the copy detector for SqlLog:\r\n      Looking for potential copies within User Name 1_3196... OK\r\n      Looking for potential copies within User Name 2_2987... OK\r\n      Looking for potential copies within User Name 3_0981... OK\r\n\r\nRunning on batch mode for User Name 1_3196:\r\n\r\n   Restoring BBDD permissions:\r\n      Dropping role rrhhadmin... OK\r\n      Dropping role prodadmin... OK\r\n      Dropping role dbadmin... OK\r\n      Dropping user it... OK\r\n      Creating user it... OK\r\n      Creating role rrhhadmin... OK\r\n      Creating role prodadmin... OK\r\n      Creating role dbadmin... OK\r\n\r\n   Setting up SQL dump:\r\n      Getting student name... OK\r\n      Getting database name... OK\r\n      Looking for the SQL dump... OK\r\n      Replacing the database name... OK\r\n      Replacing the database connection... OK\r\n      Storing changes... OK\r\n\r\n   Importing SQL dump:\r\n      Restoring database empresa-permissions-User-Name-1    using the file empresa_abderrahman_elmzouri.sql... OK\r\n\r\n   No potential copy detected for User Name 1_3196/postgresql-12-main.log:\r\n      Match score with User Name 2_2987/postgresql-12-main.log... 44,63 %\r\n      Match score with User Name 3_0981/postgresql-12-main.log... 39,43 %\r\n\r\n   No potential copy has been detected.\r\n\r\n   Question 1 [0 points] - This questions does not score:\r\n\r\n   Question 2 [1 point] - Foreign key (I):\r\n      Checking foreign key 'empleats -> empleats'...OK\r\n\r\n   Question 3 [1 point] - Foreign key (II):\r\n      Checking foreign key 'empleats -> departaments'...OK\r\n\r\n   Question 4 [1 point] - Privileges over 'empleats':\r\n      Checking new entries...OK\r\n      Checking table privileges...OK\r\n\r\n   Question 5 [0 points] - This questions does not score:\r\n\r\n   Question 6 [1 point] - Privileges over 'fabricacio':\r\n      Checking foreign key 'fabricacio -> fabriques'...OK\r\n      Checking foreign key 'fabricacio -> productes'...OK\r\n      Checking table privileges...OK\r\n\r\n   Question 7 [2 points] - Privileges over 'fabriques':\r\n      Checking foreign key 'fabriques -> empleats'...OK\r\n      Checking schema privileges...OK\r\n      Checking table privileges...OK\r\n\r\n   Question 8 [1 point] - Privileges for rrhhadmin and prodadmin:\r\n      Checking removed entries...OK\r\n      Checking 'rrhhadmin' privileges for the table 'empleats'...OK\r\n      Checking 'rrhhadmin' privileges for the table 'departaments'...OK\r\n      Checking 'prodadmin' privileges for the table 'fabriques'...OK\r\n      Checking 'prodadmin' privileges for the table 'productes'...OK\r\n      Checking 'prodadmin' privileges for the table 'fabricacio'...OK\r\n\r\n   Question 9 [3 points] - Privileges for dbadmin:\r\n\r\n      Question 9.1 [1 point] - Role membership:\r\n         Checking dbadmin membership...OK\r\n\r\n      Question 9.2 [2 points] - Role privileges:\r\n         Checking 'dbadmin' privileges for the table 'empleats'...OK\r\n         Checking 'dbadmin' privileges for the table 'departaments'...OK\r\n         Checking 'dbadmin' privileges for the table 'fabriques'...OK\r\n         Checking 'dbadmin' privileges for the table 'productes'...OK\r\n         Checking 'dbadmin' privileges for the table 'fabricacio'...OK\r\n\r\n   TOTAL SCORE: 10 / 10\r\n\r\nRunning script ASIX - M02 (UF3): Permissions Assignment (v1.2.0.0):\r\n   Extracting files at User Name 1_3196:\r\n      Extracting the file var.zip... OK\r\n\r\n   Extracting files at User Name 2_2987:\r\n      Extracting the file var.zip... OK\r\n\r\n   Extracting files at User Name 3_0981:\r\n      Extracting the file var.zip... OK\r\n\r\n   Starting the copy detector for SqlLog:\r\n      Looking for potential copies within User Name 1_3196... OK\r\n      Looking for potential copies within User Name 2_2987... OK\r\n      Looking for potential copies within User Name 3_0981... OK\r\n\r\nRunning on batch mode for User Name 2_2987:\r\n\r\n   Restoring BBDD permissions:\r\n      Dropping role rrhhadmin... OK\r\n      Dropping role prodadmin... OK\r\n      Dropping role dbadmin... OK\r\n      Dropping user it... OK\r\n      Creating user it... OK\r\n      Creating role rrhhadmin... OK\r\n      Creating role prodadmin... OK\r\n      Creating role dbadmin... OK\r\n\r\n   Setting up SQL dump:\r\n      Getting student name... OK\r\n      Getting database name... OK\r\n      Looking for the SQL dump... OK\r\n      Replacing the database name... OK\r\n      Replacing the database connection... OK\r\n      Storing changes... OK\r\n\r\n   Importing SQL dump:\r\n      Restoring database empresa-permissions-User-Name-2    using the file empresa_David_Ferrero.sql... OK\r\n\r\n   No potential copy detected for User Name 2_2987/postgresql-12-main.log:\r\n      Match score with User Name 1_3196/postgresql-12-main.log... 44,63 %\r\n      Match score with User Name 3_0981/postgresql-12-main.log... 40,13 %\r\n\r\n   No potential copy has been detected.\r\n\r\n   Question 1 [0 points] - This questions does not score:\r\n\r\n   Question 2 [1 point] - Foreign key (I):\r\n      Checking foreign key 'empleats -> empleats'...OK\r\n\r\n   Question 3 [1 point] - Foreign key (II):\r\n      Checking foreign key 'empleats -> departaments'...OK\r\n\r\n   Question 4 [1 point] - Privileges over 'empleats':\r\n      Checking new entries...OK\r\n      Checking table privileges...OK\r\n\r\n   Question 5 [0 points] - This questions does not score:\r\n\r\n   Question 6 [1 point] - Privileges over 'fabricacio':\r\n      Checking foreign key 'fabricacio -> fabriques'...OK\r\n      Checking foreign key 'fabricacio -> productes'...OK\r\n      Checking table privileges...OK\r\n\r\n   Question 7 [2 points] - Privileges over 'fabriques':\r\n      Checking foreign key 'fabriques -> empleats'...OK\r\n      Checking schema privileges...OK\r\n      Checking table privileges...OK\r\n\r\n   Question 8 [1 point] - Privileges for rrhhadmin and prodadmin:\r\n      Checking removed entries...OK\r\n      Checking 'rrhhadmin' privileges for the table 'empleats'...OK\r\n      Checking 'rrhhadmin' privileges for the table 'departaments'...OK\r\n      Checking 'prodadmin' privileges for the table 'fabriques'...OK\r\n      Checking 'prodadmin' privileges for the table 'productes'...OK\r\n      Checking 'prodadmin' privileges for the table 'fabricacio'...OK\r\n\r\n   Question 9 [3 points] - Privileges for dbadmin:\r\n\r\n      Question 9.1 [1 point] - Role membership:\r\n         Checking dbadmin membership...OK\r\n\r\n      Question 9.2 [2 points] - Role privileges:\r\n         Checking 'dbadmin' privileges for the table 'empleats'...OK\r\n         Checking 'dbadmin' privileges for the table 'departaments'...OK\r\n         Checking 'dbadmin' privileges for the table 'fabriques'...OK\r\n         Checking 'dbadmin' privileges for the table 'productes'...OK\r\n         Checking 'dbadmin' privileges for the table 'fabricacio'...OK\r\n\r\n   TOTAL SCORE: 10 / 10\r\n\r\nRunning script ASIX - M02 (UF3): Permissions Assignment (v1.2.0.0):\r\n   Extracting files at User Name 1_3196:\r\n      Extracting the file var.zip... OK\r\n\r\n   Extracting files at User Name 2_2987:\r\n      Extracting the file var.zip... OK\r\n\r\n   Extracting files at User Name 3_0981:\r\n      Extracting the file var.zip... OK\r\n\r\n   Starting the copy detector for SqlLog:\r\n      Looking for potential copies within User Name 1_3196... OK\r\n      Looking for potential copies within User Name 2_2987... OK\r\n      Looking for potential copies within User Name 3_0981... OK\r\n\r\nRunning on batch mode for User Name 3_0981:\r\n\r\n   Restoring BBDD permissions:\r\n      Dropping role rrhhadmin... OK\r\n      Dropping role prodadmin... OK\r\n      Dropping role dbadmin... OK\r\n      Dropping user it... OK\r\n      Creating user it... OK\r\n      Creating role rrhhadmin... OK\r\n      Creating role prodadmin... OK\r\n      Creating role dbadmin... OK\r\n\r\n   Setting up SQL dump:\r\n      Getting student name... OK\r\n      Getting database name... OK\r\n      Looking for the SQL dump... OK\r\n      Replacing the database name... OK\r\n      Replacing the database connection... OK\r\n      Storing changes... OK\r\n\r\n   Importing SQL dump:\r\n      Restoring database empresa-permissions-User-Name-3    using the file empresa_marc_hannouti.sql... OK\r\n\r\n   No potential copy detected for User Name 3_0981/postgresql-12-main.log:\r\n      Match score with User Name 1_3196/postgresql-12-main.log... 39,43 %\r\n      Match score with User Name 2_2987/postgresql-12-main.log... 40,13 %\r\n\r\n   No potential copy has been detected.\r\n\r\n   Question 1 [0 points] - This questions does not score:\r\n\r\n   Question 2 [1 point] - Foreign key (I):\r\n      Checking foreign key 'empleats -> empleats'...OK\r\n\r\n   Question 3 [1 point] - Foreign key (II):\r\n      Checking foreign key 'empleats -> departaments'...OK\r\n\r\n   Question 4 [1 point] - Privileges over 'empleats':\r\n      Checking new entries...OK\r\n      Checking table privileges...OK\r\n\r\n   Question 5 [0 points] - This questions does not score:\r\n\r\n   Question 6 [1 point] - Privileges over 'fabricacio':\r\n      Checking foreign key 'fabricacio -> fabriques'...ERROR:\n         -Expected -> True; Found -> False\r\n      Checking foreign key 'fabricacio -> productes'...ERROR:\n         -Expected -> True; Found -> False\r\n      Checking table privileges...ERROR:\n         -Expected -> %x%; Found -> arwdDt\r\n\r\n   Question 7 [2 points] - Privileges over 'fabriques':\r\n      Checking foreign key 'fabriques -> empleats'...ERROR:\n         -Expected -> True; Found -> False\r\n      Checking schema privileges...ERROR:\n         -Expected -> %U%; Found -> \r\n      Checking table privileges...OK\r\n\r\n   Question 8 [1 point] - Privileges for rrhhadmin and prodadmin:\r\n      Checking removed entries...ERROR:\n         -Expected -> 0; Found -> 1\r\n      Checking 'rrhhadmin' privileges for the table 'empleats'...ERROR:\n         -Expected -> arwxt; Found -> arwdDxt\r\n      Checking 'rrhhadmin' privileges for the table 'departaments'...ERROR:\n         -Expected -> arwxt; Found -> arwdDxt\r\n      Checking 'prodadmin' privileges for the table 'fabriques'...ERROR:\n         -Expected -> arwxt; Found -> arwdDxt\r\n      Checking 'prodadmin' privileges for the table 'productes'...ERROR:\n         -Expected -> arwxt; Found -> arwdDt\r\n      Checking 'prodadmin' privileges for the table 'fabricacio'...ERROR:\n         -Expected -> arwxt; Found -> arwdDxt\r\n\r\n   Question 9 [3 points] - Privileges for dbadmin:\r\n\r\n      Question 9.1 [1 point] - Role membership:\r\n         Checking dbadmin membership...ERROR:\n            -Expected -> [prodadmin,rrhhadmin]; Found -> []\r\n\r\n      Question 9.2 [2 points] - Role privileges:\r\n         Checking 'dbadmin' privileges for the table 'empleats'...ERROR:\n            -Expected -> dD; Found -> dDx\r\n         Checking 'dbadmin' privileges for the table 'departaments'...OK\r\n         Checking 'dbadmin' privileges for the table 'fabriques'...ERROR:\n            -Expected -> dD; Found -> \r\n         Checking 'dbadmin' privileges for the table 'productes'...ERROR:\n            -Expected -> dD; Found -> \r\n         Checking 'dbadmin' privileges for the table 'fabricacio'...ERROR:\n            -Expected -> dD; Found -> \r\n\r\n   TOTAL SCORE: 3 / 10";
            Assert.AreEqual(expected, s.Output.ToString());
        }
    }
}